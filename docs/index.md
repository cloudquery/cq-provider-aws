# AWS Provider

The CloudQuery AWS provider extracts and transforms your AWS cloud assets configuration into PostgreSQL.

This provider also supports additional capabilities:
- [Terraform Drift Detection](https://docs.cloudquery.io/docs/cli/drift/overview)

## Install

```shell
cloudquery init aws
```

## Authentication

To authenticate CloudQuery with your AWS account you can use any of the following options (see full documentation at [AWS SDK V2](https://aws.github.io/aws-sdk-go-v2/docs/configuring-sdk/#specifying-credentials)):

- Environment variables: `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_SESSION_TOKEN`, `AWS_PROFILE`
- Shared configuration files (via `aws configure`).
  - SDK defaults to `credentials` file under `.aws` folder that is placed in the home folder on your computer.
  - SDK defaults to `config` file under `.aws` folder that is placed in the home folder on your computer.
  - SDK is able to use SSO credentials stored in the `~/.aws/` directory
- The SDK is able to use the IAM role associated with AWS Compute resources including (EC2 instances, Fargate and ECS containers, and Lambda Functions)

## Configuration

The following configuration section can be automatically generated by `cloudquery init aws`:

```hcl
provider "aws" {
  configuration {
    // Optional. if you want to assume role to multiple account and fetch data from them
    // Optional. by default assumes all regions or explicitly state all regions by including the `*` character as the only argument in the array
    // regions = ["us-east-1", "us-west-2"]
    // accounts "<YOUR ID>" {
      // Optional. Role ARN we want to assume when accessing this account
      // role_arn = < YOUR_ROLE_ARN >
      // override provider configs for a specific account
      // regions = ["us-east-1", "us-east-2"]
    }
    // Optional. Enable AWS SDK debug logging.
    // aws_debug = false
    // The maximum number of times that a request will be retried for failures. Defaults to 5 retry attempts.
    max_retries = 5
    // The maximum back off delay between attempts. The backoff delays exponentially with a jitter based on the number of attempts. Defaults to 60 seconds.
    // max_backoff = 30
  }

  resources = ["*"]
}
```

By default, CloudQuery will fetch all configuration from **all** supported resources in **all** commercial regions in the **default** account. You can change this behavior with the following arguments:

#### Arguments for AWS Provider block

- `accounts` **(Optional)** - Specify multiple accounts to fetch data from them concurrently and then query across accounts. The default configured account should be able [AssumeRole](https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html) to the specified accounts.
- `regions` **(Optional)** - limit fetching to specific regions. You can specify all regions by using the `*` character as the only argument in the array
- `max_retries` **(Optional)** - The maximum number of times that a request will be retried for failures. Defaults to 5 retry attempts.
- `max_backoff` **(Optional)** - The maximum back off delay between attempts. The backoff delays exponentially with a jitter based on the number of attempts. Defaults to 60 seconds.
- `aws_debug` **(Optional)** - This will print very verbose/debug output from AWS SDK. Defaults to false.

### Multi Account Configuration

CloudQuery can fetch from multiple accounts in parallel by using AssumeRole (You will need to use credentials that can AssumeRole to all other specified account. Following is an example configuration:

```hcl
provider "aws" {
  configuration {
    // Optional. if you want to assume role to multiple account and fetch data from them
    accounts "<AccountID_Alias_2>" {
      // Optional. Role ARN we want to assume when accessing this account
      role_arn = <YOUR_ROLE_ARN_1>
      // Optional. Local Profile is the named profile in your shared configuration file (usually `~/.aws/config`) that you want to use for this specific account
      local_profile = "<NAMED_PROFILE>
    }
    accounts "<AccountID_Alias_2>" {
      // Optional. Role ARN we want to assume when accessing this account
      role_arn = <YOUR_ROLE_ARN_2>
    }
  }

  resources = ["*"]
}
```

#### Arguments for Accounts block:

- `role_arn`  **(Optional)** - The role that CloudQuery will use to perform the fetch
- `local_profile`  **(Optional)** - Local Profile is the named profile in your shared configuration file (usually `~/.aws/config`) that you want to use for the account
- `external_id`    **(Optional)** - The unique identifier used to by non aws entities to assume a role in an AWS account
- `regions`  **(Optional)** - Limit fetching resources within this specific account to only these regions. This will override any regions specified in the provider block. You can specify all regions by using the `*` character as the only argument in the array



### Assume Role with MFA

In order to assume role with MFA, you need to request temporary credentials using STS "get-session-token".

```bash
aws sts get-session-token --serial-number <YOUR_MFA_SERIAL_NUMBER> --token-code <YOUR_MFA_TOKEN_CODE> --duration-seconds 3600
```

export the temporary credentials to your environment variables.

```bash
export AWS_ACCESS_KEY_ID=<YOUR_ACCESS_KEY_ID>
export AWS_SECRET_ACCESS_KEY=<YOUR_SECRET_ACCESS_KEY>
export AWS_SESSION_TOKEN=<YOUR_SESSION_TOKEN>
```


## Query Examples

### Find all public facing load balancers

```sql
SELECT * FROM aws_elbv2_load_balancers WHERE scheme = 'internet-facing';
```

### Find all unencrypted RDS instances

```sql
SELECT * FROM aws_rds_clusters WHERE storage_encrypted IS FALSE;
```

### Find all unencrypted buckets

```sql
SELECT * FROM aws_rds_clusters WHERE storage_encrypted IS FALSE;
```

## Building the Provider:

``` bash
make build
```


Running Provider locally:
1. Clone repository to local machine

2. [Optional] Start a local database:
    ```bash
    make pg-start
    ```
3. [Optional] Configure the `config.hcl`
    ```bash
    make os=Linux arch=arm64 install 
    ./cloudquery init aws
    ```
4. Start the provider in a different tab/session
    ```bash
    make run
    ```
5. Execute Cloudquery Fetch using the locally built provider
    ```bash
    make fetch
    ```

More information can be found in the [CloudQuery documentation](https://docs.cloudquery.io/docs/developers/debugging)